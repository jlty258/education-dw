name: Datafold-like CI/CD Pipeline

on:
  pull_request:
    paths:
      - 'schemas/**/*.json'
      - 'sql/**/*.sql'
      - 'scripts/**/*.py'
  push:
    branches:
      - main
    paths:
      - 'schemas/**/*.json'
      - 'sql/**/*.sql'

jobs:
  validate-schema:
    name: Schema 验证
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: 设置 Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: 安装依赖
        run: |
          pip install jsonschema
          pip install data-diff || echo "data-diff 未安装，跳过数据对比"
      
      - name: 验证 Schema 文件
        run: |
          python3 -c "
          import json
          import jsonschema
          from pathlib import Path
          
          schemas_dir = Path('schemas')
          errors = []
          
          for schema_file in schemas_dir.rglob('*.json'):
              if schema_file.name == 'base_schema.json':
                  continue
              try:
                  with open(schema_file, 'r') as f:
                      schema = json.load(f)
                      jsonschema.Draft202012Validator.check_schema(schema)
                  print(f'✓ {schema_file} 验证通过')
              except Exception as e:
                  errors.append(f'{schema_file}: {e}')
                  print(f'✗ {schema_file} 验证失败: {e}')
          
          if errors:
              print('\\nSchema 验证失败:')
              for error in errors:
                  print(f'  - {error}')
              exit(1)
          "
      
      - name: 检查 Schema 变更
        run: |
          echo "检查 Schema 变更..."
          git diff HEAD~1 HEAD --name-only | grep -E 'schemas/.*\.json$' || echo "无 Schema 变更"
  
  validate-data-quality:
    name: 数据质量验证
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - uses: actions/checkout@v3
      
      - name: 设置 Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: 安装依赖
        run: |
          pip install data-diff || echo "data-diff 未安装"
      
      - name: 运行数据质量检查
        run: |
          echo "数据质量检查（需要数据库连接）"
          # 实际环境中需要配置数据库连接
          # python3 scripts/datafold_platform.py
          echo "跳过数据质量检查（需要数据库连接）"
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
  
  validate-sql:
    name: SQL 语法验证
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: 检查 SQL 文件
        run: |
          echo "检查 SQL 文件语法..."
          find sql -name "*.sql" -type f | while read file; do
              echo "检查: $file"
              # 这里可以添加 SQL 语法检查工具
          done
          echo "SQL 文件检查完成"

